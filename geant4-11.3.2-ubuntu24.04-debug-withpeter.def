Bootstrap: docker
From: ubuntu:24.04

%post
    # Install required packages
    # Install development tools and dependencies
    apt-get update
    apt-get -y install bzip2 build-essential cmake git qtcreator qtbase5-dev qt5-qmake wget libexpat1-dev libxerces-c-dev nano emacs vim

    # Create build and installation directories
    mkdir -p /tmp/geant4/build /opt/geant4/

    # Download and install Geant4
    cd /tmp/geant4
    wget -O geant4-v11.3.2.tar.bz2 "https://gitlab.cern.ch/geant4/geant4/-/archive/v11.3.2/geant4-v11.3.2.tar.bz2"
    bunzip2 -dc geant4-v11.3.2.tar.bz2 | tar -xf -

    # get and apply patches for modifications by Peter
    wget -O geant4-diff-20250618-peter.diff "https://www.physi.uni-heidelberg.de/~schiller/geant4-diff-20250618-peter.diff"
    cd geant4-v11.3.2
    patch -p0 < ../geant4-diff-20250618-peter.diff
    cd ..

    # Configure and build Geant4
    cd build
    cmake ../geant4-v11.3.2 \
	-DCMAKE_BUILD_TYPE=RelWithDebInfo \
        -DCMAKE_C_FLAGS="-O2 -g -march=native -fno-omit-frame-pointer -ffast-math -fno-associative-math -ftree-vectorize -fstack-protector-strong -fstack-clash-protection -D_REENTRANT -U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=1 -UNDEBUG -fPIE -fPIC" \
        -DCMAKE_CXX_FLAGS="-O2 -g -march=native -fno-omit-frame-pointer -ffast-math -fno-associative-math -ftree-vectorize -fstack-protector-strong -fstack-clash-protection -D_REENTRANT -U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=1 -UNDEBUG -fPIE -fPIC" \
        -DCMAKE_Fortran_FLAGS="-O2 -g -march=native -fno-omit-frame-pointer -ffast-math -fno-associative-math -ftree-vectorize -fstack-protector-strong -fstack-clash-protection -D_REENTRANT -U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=1 -fPIE -fPIC" \
        -DCMAKE_EXE_LINKER_FLAGS="-O2 -g -pie -Wl,-z,defs -Wl,-z,relro -Wl,-z,now" \
        -DCMAKE_SHARED_LINKER_FLAGS="-O2 -g -pie -shared -Wl,-z,defs -Wl,-z,relro -Wl,-z,now" \
        -DCMAKE_INSTALL_PREFIX=/opt/geant4 \
        -DGEANT4_INSTALL_DATA=ON \
        -DGEANT4_USE_GDML=ON \
	-DGEANT4_USE_QT=ON \
        -DGEANT4_USE_SYSTEM_EXPAT=ON \
        -DGEANT4_BUILD_MULTITHREADED=ON

    # Build and install
    make -j$(nproc)
    make install

    # Cleanup
    cd /tmp/geant4
    rm -fr build geant4-v11.3.2
    rm -f geant4-v11.3.2.tar.bz2 geant4-diff-20250618-peter.diff
    cd /tmp
    rmdir geant4
    rm -f /root/*.pkg.tar*
    rm -f /root/*.tar.gz 

%files

%environment
export PATH="/opt/geant4/bin:${PATH}"
export LD_LIBRARY_PATH="/opt/geant4/lib:${LD_LIBRARY_PATH}"
export G4INSTALL="/opt/geant4"
export G4EXAMPLES="/opt/geant4/share/Geant4/examples"
export G4NEUTRONHPDATA="/opt/geant4/share/Geant4/data/G4NDL4.7.1"
export G4LEDATA="/opt/geant4/share/Geant4/data/G4EMLOW8.6.1"
export G4LEVELGAMMADATA="/opt/geant4/share/Geant4/data/PhotonEvaporation6.1"
export G4RADIOACTIVEDATA="/opt/geant4/share/Geant4/data/RadioactiveDecay6.1.2"
export G4PARTICLEXSDATA="/opt/geant4/share/Geant4/data/G4PARTICLEXS4.1"
export G4PIIDATA="/opt/geant4/share/Geant4/data/G4PII1.3"
export G4REALSURFACEDATA="/opt/geant4/share/Geant4/data/RealSurface2.2"
export G4SAIDXSDATA="/opt/geant4/share/Geant4/data/G4SAIDDATA2.0"
export G4ABLADATA="/opt/geant4/share/Geant4/data/G4ABLA3.3"
export G4INCLDATA="/opt/geant4/share/Geant4/data/G4INCL1.2"
export G4ENSDFSTATEDATA="/opt/geant4/share/Geant4/data/G4ENSDFSTATE3.0"

%runscript
    exec "$@"

%help
Geant4-11.3.2-1
Built with system xerces-c for GDML support
